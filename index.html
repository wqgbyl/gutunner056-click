<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>调音器 + 自动BPM(♩) + 自动对齐节拍器（AudioWorklet）</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>
    <h1>调音器 + 自动 BPM(♩) + 自动对齐节拍器</h1>
    <p class="sub">录音（人声/双簧管）→ 实时音高 → 录后分析：♩=BPM + 拍点相位 → WebAudio 回放叠加节拍器（同步）</p>
  </header>

  <main>
    <section class="card">
      <h2>录音与分析</h2>
      <div class="row">
        <button id="btnStart">开始录音</button>
        <button id="btnStop" disabled>停止</button>
        <span id="status" class="status">未开始</span>
      </div>

      <div class="grid">
        <div class="metric">
          <div class="label">当前音名</div>
          <div class="value" id="noteName">—</div>
        </div>
        <div class="metric">
          <div class="label">频率</div>
          <div class="value" id="freqHz">—</div>
        </div>
        <div class="metric">
          <div class="label">音准偏差</div>
          <div class="value" id="cents">—</div>
        </div>
        <div class="metric">
          <div class="label">四分音符速度</div>
          <div class="value" id="tempo">♩=—</div>
        </div>
        <div class="metric">
          <div class="label">Tempo 置信度</div>
          <div class="value" id="tempoConf">—</div>
        </div>
      </div>

      <div class="hint">
        <ul>
          <li>建议录音 ≥ 8 秒，BPM/对齐更稳定。</li>
          <li>本版回放与节拍器都在 <b>同一个 WebAudio 时间轴</b>，避免手机/浏览器播放器不同步。</li>
          <li>你之后把既有的分段/换音确认逻辑接入 <code>src/dsp/pitchTracker.js</code> 即可。</li>
        </ul>
      </div>
    </section>

    <section class="card">
      <h2>回放 + 节拍器</h2>
      <div class="row">
        <button id="btnPlay" disabled>回放（同步节拍器）</button>
        <button id="btnStopPlay" disabled>停止回放</button>
      </div>

      <div class="row">
        <label class="checkbox">
          <input type="checkbox" id="metOn" checked />
          启用节拍器
        </label>
      </div>

      <div class="row">
        <label class="slider">
          节拍器音量
          <input type="range" id="metGain" min="0" max="1" step="0.01" value="0.25" />
          <span id="metGainVal">0.25</span>
        </label>
      </div>

      <div class="row">
        <div class="small">录音时长：<span id="dur">—</span></div>
        <div class="small">拍点对齐偏移：<span id="beatOffset">—</span></div>
      </div>

      <p class="small">提示：必须通过本地服务器或 GitHub Pages（HTTPS）访问；AudioWorklet 需要安全上下文/模块加载。</p>
    </section>

    <section class="card">
      <h2>如何运行</h2>
      <ol>
        <li>安装 Node.js（如果你没有）。</li>
        <li>在本目录运行：<code>npx http-server -p 5173</code></li>
        <li>浏览器打开：<code>http://localhost:5173</code></li>
      </ol>
    </section>
  </main>

  <footer>
    <span class="small">AudioWorklet 同步版 · Chrome/Edge 优先</span>
  </footer>

  <script type="module" src="./src/main.js"></script>
</body>
</html>
